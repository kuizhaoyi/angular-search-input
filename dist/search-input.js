angular.module("search.input",[]).run(["$templateCache",function(e){e.put("search/input/templates/searchInput.html",'<div id="searchWrap" class="searchWrap">\n    <div class="searchInput">\n        <div class="searchPro">\n            <form>\n                <table>\n                    <tr ng-repeat="item in queryProList" search-pro-item search-item="item" search-item-index="$index" search-item-total="queryProList.length"\n                        add-action="addProItem()" delete-action="deleteProItem(item)" config="config"></tr>\n                </table>\n                <div class="text-center">\n                    <button class="btn btn-search" ng-click="execProSearch()">\n                        <i class="ion-ios-search-strong"></i> 搜索</button>\n                    <button class="btn btn-reset" ng-click="resetProSearch()">\n                        <i class="ion-ios-undo"></i> 重置</button>\n                </div>\n            </form>\n        </div>\n    </div>\n</div>'),e.put("search/input/templates/searchProItem.html",'<tr class="form-group">\n    <td class="item-0">\n        <a class="btn btn-default" ng-show="searchItemIndex > 0 && searchItemIndex == searchItemTotal - 1" ng-click="addAction()">+</a>\n    </td>\n    <td class="item-1">\n        <span ng-show="searchItemIndex>0">\n                <ui-select theme="selectize" ng-model="searchItem.logic" title="">\n                    <ui-select-match placeholder="">{{$select.selected.title}}</ui-select-match>\n                    <ui-select-choices repeat="item.val as item in logicList">\n                        <div ng-bind-html="item.title"></div>\n                    </ui-select-choices>\n                </ui-select>\n         </span>\n        <a class="btn btn-default" style="float:right" ng-show="searchItemIndex == 0 && searchItemIndex == searchItemTotal - 1" ng-click="addAction()">+</a>\n    </td>\n    <td class="item-2">\n        <ui-select theme="selectize" ng-model="searchItem.attr" title="输入要搜索的字段">\n            <ui-select-match placeholder="输入要搜索的字段">{{$select.selected.name || $select.selected}}</ui-select-match>\n            <ui-select-choices repeat="item in queryAttrList  track by $index" refresh="searchKeyword($select.search)" refresh-delay="0">\n                <div ng-bind-html="item.name | highlight: $select.search"></div>\n                \x3c!-- <small ng-bind-html="item.group_name | highlight: $select.search "></small> --\x3e\n            </ui-select-choices>\n        </ui-select>\n    </td>\n    <td class="item-3">\n        <ui-select theme="selectize" ng-model="searchItem.operation" title="">\n            <ui-select-match placeholder="">{{$select.selected.title}}</ui-select-match>\n            <ui-select-choices repeat="item.val as item in operationList">\n                <div ng-bind-html="item.title"></div>\n            </ui-select-choices>\n        </ui-select>\n    </td>\n    <td class="item-4">\n        <input ng-model="searchItem.keyword" type="text" />\n    </td>\n    <td class="item-5">\n        <a class="btn btn-default" ng-show="searchItemTotal > 1" ng-click="deleteAction()">-</button>\n    </td>\n</tr>')}]);
angular.module("search.input").directive("searchInput",function(){return{restrict:"EA",templateUrl:"search/input/templates/searchInput.html",replace:!0,scope:{config:"="},controller:["$rootScope","$scope","$element","$attrs","$localStorage",function(e,o,r,i,t){o.addProItem=function(){o.queryProList.push({logic:"and",operation:"="})},o.deleteProItem=function(e){var r=o.queryProList.indexOf(e);o.queryProList.splice(r,1)},o.execProSearch=function(){t["queryProList"+o.cacheType||""]=o.queryProList;var s,y="",e={},u=[];angular.forEach(o.queryProList,function(e,r){if(e.operation&&e.keyword&&e.attr&&e.attr.val){var o="";if(0!=r&&y){if(e.logic)"not"==(c=e.logic)&&(c=" and "+c),o+=" "+c+" "+e.attr.val}else o+=" "+e.attr.val;if(o){var i=e.keyword,t=e.operation;if("like"==e.operation)i="'%"+i+"%'";else if("="==e.operation)if(e.keyword&&-1!=e.keyword.indexOf(",")){var n=e.keyword.split(",");for(var r in i="(",n)i+="'"+n[r]+"'",r!=n.length-1&&(i+=",");i+=")",t="in"}else i="'"+i+"'";else i="'"+i+"'";y+=o+=" "+t+" "+i;var a,c=e.logic||"and",l=e.attr.val;if("="==e.operation)if(e.keyword&&-1!=e.keyword.indexOf(","))a={$in:n=e.keyword.split(",")};else a=e.keyword;else if(">"==e.operation)a={$gt:e.keyword};else if(">="==e.operation)a={$gte:e.keyword};else if("<"==e.operation)a={$lt:e.keyword};else if("<="==e.operation)a={$lte:e.keyword};else if("!="==e.operation){if(e.keyword&&-1!=e.keyword.indexOf(","))a={$nin:n=e.keyword.split(",")};else a={$ne:e.keyword}}else"like"==e.operation&&(a={$regex:e.keyword});if(-1!=c.indexOf("and"))s||(s={}),s[l]=a;else if(-1!=c.indexOf("or")){(n={})[l]=a,u.push(n)}}}}),s&&u.push(s),0<u.length&&(e.$or=u);var r={query:y=$.trim(y),queryMongo:e,queryKeyWord:""};t.execQuery=r,o.config.onClickSearch(r)},o.resetProSearch=function(){o.queryProList=[],o.queryProList.push({logic:"and",operation:"="}),t["queryProList"+o.cacheType||""]=o.queryProList},o.config.onClickTab=function(e){e&&(t["queryProList"+o.cacheType||""]=o.queryProList||[],o.cacheType=e.cacheType),o.queryProList=t["queryProList"+o.cacheType||""]||[],o.queryProList.length<=0&&o.queryProList.push({logic:"and",operation:"="})},o.config.onClickTab()}]}});
angular.module("search.input").directive("searchProItem",function(){return{restrict:"EA",templateUrl:"search/input/templates/searchProItem.html",replace:!0,scope:{addAction:"&",deleteAction:"&",searchItem:"=",searchItemIndex:"=",searchItemTotal:"=",config:"="},controller:["$rootScope","$scope","$element","$attrs",function(t,l,e,i){l.operationList=[{title:"等于",val:"="},{title:"大于",val:">"},{title:"小于",val:"<"},{title:"大于等于",val:">="},{title:"小于等于",val:"<="},{title:"包含",val:"like"}],l.operationListMongo=[{title:"等于",val:"="},{title:"大于",val:">"},{title:"小于",val:"<"},{title:"大于等于",val:">="},{title:"小于等于",val:"<="},{title:"包含",val:"like"},{title:"不等于",val:"!="}],l.logicList=[{title:"与",val:"and"},{title:"或",val:"or"},{title:"与非",val:"and not"},{title:"或非",val:"or not"}],l.logicListMongo=[{title:"与",val:"and"},{title:"或",val:"or"}],l.queryAttrList=[],l.searchKeyword=function(e){if(l.config.searchInputField&&0<l.config.searchInputField.length){var t=l.config.searchInputField;t&&0<t.length&&(l.queryAttrList=[],angular.forEach(t,function(t){(!e||e&&-1!=t.name.indexOf(e))&&l.queryAttrList.push(t)}))}}}]}});